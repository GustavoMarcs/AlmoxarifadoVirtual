@using WebUI.Components.SharedComponents.AdminModals
@inject IDepartmentLocationService Service
@inject INotifier Notifier

<div class="container">
	<div class="header">
		<div>
			<div>
				<span style="color: #fed14b;"><LucideIcon Name="map-pin-house" Size="24" /> </span>
				<span class="ms-1 fw-medium">Localizações do Almoxarifado</span>
			</div>
			<p class="mt-3">Gerencie as localizações do almoxarifado físico </p>
		</div>
		<div class="actions">
			<button class="btn secondary">⭳ Exportar</button>
			<AddButtonTable OnClick="ShowCreateModal" Text="Localização" />
		</div>
	</div>


	<AlertBox @ref="alertBox" />


	<div>
		<SearchBar SearchText="@searchText" SearchTextChanged="@OnSearchChanged"
				   PlaceHolder="Pesquise uma localização. Ex: Galpão 3" />
	</div>

	<div class="table-wrapper mt-2">
		<table class="mb-4">
			<thead>
				<tr>
					<th @onclick="@(() => SortBy("name"))" style="cursor: pointer">
						Nome
						<LucideIcon Name="chevron-down" />
					</th>
					<th class="table-description" @onclick="@(() => SortBy("description"))" style="cursor: pointer">
						Descrição
						<LucideIcon Name="chevron-down" />
					</th>
					<th @onclick="@(() => SortBy("status"))" style="cursor: pointer">
						Status
						<LucideIcon Name="chevron-down" />
					</th>
					<th @onclick="@(() => SortBy("capacity"))" style="cursor: pointer">
						Capacidade Total
						<LucideIcon Name="chevron-down" />
					</th>
					<th @onclick="@(() => SortBy("currentCapacity"))" style="cursor: pointer">
						Capacidade Atual
						<LucideIcon Name="chevron-down" />
					</th>
					<th @onclick="@(() => SortBy("productscount"))" style="cursor: pointer">
						Produtos nessa localização
						<LucideIcon Name="chevron-down" />
					</th>
					<th>Ações</th>
				</tr>
			</thead>
			<tbody>
				@if (!departmentLocations.Any())
				{
					<tr>
						<td colspan="7" class="text-center text-muted py-4">
							<div>
								<LucideIcon Name="map-pin-house" Size="48" class="mb-2" />
								<p>Nenhuma localização encontrada</p>
								<small>Clique em "Adicionar localização" para criar a primeira localização</small>
							</div>
						</td>
					</tr>
				}
				else
				{
					@foreach (var item in departmentLocations)
					{
						<tr @key="item.Id">
							<td><strong>@item.Name</strong></td>
							<td class="text-muted table-description">@item.Description</td>
							<td>
								@if (item.IsActive)
								{
									<Badge Class="d-flex justify-content-center"
										   Type="BadgeType.Success"
										   Text="Ativo"
										   Style="width: 90%; background-color: rgb(39, 214, 39);" />
								}
								else
								{
									<Badge Class="d-flex justify-content-center"
										   Type="BadgeType.Secondary"
										   Text="Inativo"
										   Style="width: 90%;" />
								}
							</td>
							<td>@item.Capacity</td>
							<td>@(item.Capacity - item.Products.Count)</td>
							<td>@item.Products.Count</td>
							<td>
								<div class="d-flex justify-content-center">
									<button class="icon-btn" @onclick="() => ShowEditModal(item.Id)">
										<LucideIcon Name="pencil" Size="18" />
									</button>
									<button class="icon-btn text-danger" @onclick="() => HandleDeleteConfirm(item.Id)">
										<LucideIcon Name="trash-2" Size="18" />
									</button>
								</div>

							</td>
						</tr>
					}
				}
			</tbody>
		</table>
	</div>

	<!-- Informações de paginação e navegação -->
	<div class="d-flex justify-content-between align-items-center mt-3">
		<!-- Informações sobre linhas por tabela -->
		<div class="text-muted small">
			Mostrando @departmentLocations.Count() de @totalRecords localizações
		</div>

		<!-- Paginação -->
		@if (totalPages > 1)
		{
			<TablePaginator Page="@currentPage"
							TotalPages="@totalPages"
							OnPageChanged="HandlePageChanged" />
		}
	</div>
</div>

<CreateDepartmentLocationModal @ref="createDepartmentLocationModal"
						   OnSave="HandleCreateDepartmentLocation" />

<EditDepartmentLocationModal @ref="editDepartmentLocationModal"
						 OnSave="HandleEditDepartmentLocation" />

<ConfirmDialog @ref="confirmDialog"
		   Title="Excluir item"
		   BodyMessage="Deseja mesmo excluir esse item?"
		   OnConfirmed="DeleteConfirmedAsync" />

@code {
	private IEnumerable<DepartmentLocation> departmentLocations = [];
	private string searchText = string.Empty;

	private CreateDepartmentLocationModal createDepartmentLocationModal = null!;
	private EditDepartmentLocationModal editDepartmentLocationModal = null!;
	private ConfirmDialog confirmDialog = null!;
	private long idToDelete;

	private AlertBox alertBox = null!;

	private string sortColumn = "name";
	private string sortOrder = "asc";
	private int currentPage = 1;
	private int totalPages;
	private int totalRecords;

	protected override async Task OnInitializedAsync()
	{
		await GetAllAsync();
	}

	private async Task GetAllAsync()
	{
		try
		{
			QueryOptions options = new(Page: currentPage, PageSize: 5,
				SortColumn: sortColumn, SortOrder: sortOrder, SearchTerm: searchText);

			PagedResult<DepartmentLocation> result = await Service.GetAllAsync(options,
				cancellationToken: CancellationToken);

			departmentLocations = result.Items;
			totalPages = result.TotalPages;
			totalRecords = result.TotalCount;

			// Ajustar página atual se necessário
			if (currentPage > totalPages && totalPages > 0)
			{
				currentPage = totalPages;
				await GetAllAsync(); // Recarregar com a página corrigida
			}
		}
		catch (Exception ex)
		{
			departmentLocations = [];
			totalPages = 1;
			currentPage = 1;
			totalRecords = 0;
			Console.WriteLine(ex.Message);
		}

		StateHasChanged();
	}

	private async Task HandleCreateDepartmentLocation(DepartmentLocation departmentLocationObject)
	{
		try
		{
			var result = await Service.AddAsync(departmentLocationObject, CancellationToken);

			if (result.IsFailure)
			{
				alertBox.Message = result.Error.Description!;
				alertBox.Type = AlertBoxType.Warning;
				alertBox.Open();
				return;
			}

			currentPage = 1; // Voltar para primeira página após criar
			await GetAllAsync();
			Notifier.Show("Localização adicionada", ToastType.Success);
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Erro ao criar categoria: {ex.Message}");
		}
	}

	private void ShowCreateModal()
	{
		createDepartmentLocationModal.Open();
	}

	private async Task ShowEditModal(long id)
	{
		await editDepartmentLocationModal.Open(id);
	}

	private async Task HandleEditDepartmentLocation(DepartmentLocation departmentLocationObject)
	{
		try
		{
			var result = await Service.UpdateAsync(departmentLocationObject, CancellationToken);

			if (result.IsFailure)
			{
				alertBox.Message = result.Error.Description!;
				alertBox.Type = AlertBoxType.Warning;
				alertBox.Open();
				return;
			}

			await GetAllAsync();
			Notifier.Show("Localização atualizada", ToastType.Success);
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Erro ao editar categoria: {ex.Message}");
		}
	}

	private void HandleDeleteConfirm(long id)
	{
		idToDelete = id;
		confirmDialog.Open();
	}

	private async Task DeleteConfirmedAsync()
	{
		try
		{
			var result = await Service.DeleteAsync(idToDelete, CancellationToken);

			if (result.IsFailure)
			{
				alertBox.Message = result.Error.Description!;
				alertBox.Type = AlertBoxType.Warning;
				alertBox.Open();
				return;
			}

			await GetAllAsync();
			Notifier.Show("Localização removida", ToastType.Success);
		}
		catch (Exception ex)
		{
			Console.WriteLine(ex.Message);
		}
	}


	private async Task SortBy(string column)
	{
		if (sortColumn == column)
		{
			sortOrder = sortOrder == "asc" ? "desc" : "asc";
		}
		else
		{
			sortColumn = column;
			sortOrder = "asc";
		}

		currentPage = 1; // Resetar para primeira página ao ordenar
		await GetAllAsync();
	}


	private async Task HandlePageChanged(int newPage)
	{
		if (newPage >= 1 && newPage <= totalPages)
		{
			currentPage = newPage;
			await GetAllAsync();
		}
	}

	private async Task OnSearchChanged(string value)
	{
		searchText = value;
		currentPage = 1; // Resetar para primeira página ao buscar
		await Debounce(GetAllAsync);
	}

}
