@using WebUI.Components.SharedComponents.AdminModals
@rendermode InteractiveServer
@inject IProductCategoryService Service
@inject INotifier Toast


<div class="container">
    <div class="header">
        <div>
            <div>
                <span style="color: #1cd086;"><LucideIcon Name="package" Size="24" /> </span>
                <span class="ms-1 fw-medium">Categorias de Produtos</span>
            </div>
            <p class="mt-3">Gerencie as categorias de produtos utilizadas no sistema</p>
        </div>
        <div class="actions">
            <button class="btn secondary">⭳ Exportar</button>
            <AddButtonTable OnClick="ShowCreateModal" Text="Categoria" />
        </div>
    </div>

    <AlertBox @ref="alertBox" />


    <div>
        <SearchBar SearchText="@searchText" SearchTextChanged="@OnSearchChanged" PlaceHolder="Pesquise uma categoria. Ex: Eletrônicos" />
    </div>

    <div class="table-wrapper mt-2">
        <table class="mb-4">
            <thead>
                <tr>
                    <th @onclick="@(() => SortBy("name"))" style="cursor: pointer">Nome <LucideIcon Name="chevron-down" /></th>
                    <th @onclick="@(() => SortBy("productscount"))" style="cursor: pointer">Produtos <LucideIcon Name="chevron-down" /></th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                @if (!categories.Any())
                {
                    <tr>
                        <td colspan="3" class="text-center text-muted py-4">
                            <div>
                                <LucideIcon Name="package" Size="48" class="mb-2" />
                                <p>Nenhuma categoria encontrada</p>
                                <small>Clique em "Adicionar Categoria" para criar a primeira categoria</small>
                            </div>
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var item in categories)
                    {
                        <tr @key="item.Id">
                            <td><strong>@item.Name</strong></td>
                            <td>@item.SupplierProducts.Count</td>
                            <td>
                                <button class="icon-btn" @onclick="() => ShowEditModal(item.Id)"><LucideIcon Name="pencil" Size="18" /></button>
                                <button class="icon-btn text-danger" @onclick="() => HandleDeleteConfirm(item.Id)"><LucideIcon Name="trash-2" Size="18" /></button>
                            </td>
                        </tr>
                    }
                }

            </tbody>
        </table>


        <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="text-muted small">
                Mostrando @categories.Count() de @totalRecords categorias
            </div>

            @if (totalPages > 1)
            {
                <TablePaginator Page="@currentPage"
                                TotalPages="@totalPages"
                                OnPageChanged="HandlePageChanged" />
            }
        </div>
    </div>
</div>

<CreateProductCategoryModal @ref="createProductCategoryModal"
                        OnSave="HandleCreateCategory" />

<EditProductCategoryModal @ref="editProductCategoryModal"
                      OnSave="HandleEditCategory" />

<ConfirmDialog @ref="confirmDialog"
           Title="Excluir item"
           BodyMessage="Deseja mesmo excluir esse item?"
           OnConfirmed="DeleteConfirmedAsync" />

@code {
    private IEnumerable<ProductCategory> categories = [];
    private string searchText = string.Empty;

    private CreateProductCategoryModal createProductCategoryModal = null!;
    private EditProductCategoryModal editProductCategoryModal = null!;
    private ConfirmDialog confirmDialog = null!;
    private long idToDelete;

    private AlertBox alertBox = null!;

    private string sortColumn = "name";
    private string sortOrder = "asc";
    private int currentPage = 1;
    private int totalPages;
    private int totalRecords;

    protected override async Task OnInitializedAsync()
    {
        await GetAllAsync();
    }

    private async Task GetAllAsync()
    {
        try
        {
            QueryOptions options = new(Page: currentPage, PageSize: 5, SortColumn: sortColumn, SortOrder: sortOrder, SearchTerm: searchText);

            PagedResult<ProductCategory> result = await Service.GetAllAsync(options, cancellationToken: CancellationToken);

            categories = result.Items;
            totalPages = result.TotalPages;
            totalRecords = result.TotalCount;

            // Ajustar página atual se necessário
            if (currentPage > totalPages && totalPages > 0)
            {
                currentPage = totalPages;
                await GetAllAsync(); // Recarregar com a página corrigida
            }
        }
        catch (Exception ex)
        {
            categories = [];
            totalPages = 1;
            currentPage = 1;
            totalRecords = 0;
            Console.WriteLine($"Erro ao carregar categorias: {ex.Message}");
        }
    }

    private async Task HandleCreateCategory(ProductCategory categoryObject)
    {
        try
        {
            var result = await Service.AddAsync(categoryObject, CancellationToken);

            if (result.IsFailure)
            {
                alertBox.Message = result.Error.Description!;
                alertBox.Type = AlertBoxType.Warning;
                alertBox.Open();
                return;
            }

            currentPage = 1; // Voltar para primeira página após criar
            await GetAllAsync();
            Toast.Show("Categoria adicionada", ToastType.Success);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao criar categoria: {ex.Message}");
        }
    }

    private void ShowCreateModal()
    {
        createProductCategoryModal.Open();
    }

    private async Task ShowEditModal(long id)
    {
        await editProductCategoryModal.Open(id);
    }

    private async Task HandleEditCategory(ProductCategory category)
    {
        try
        {
            var result = await Service.UpdateAsync(category, CancellationToken);

            if (result.IsFailure)
            {
                alertBox.Message = result.Error.Description!;
                alertBox.Type = AlertBoxType.Warning;
                alertBox.Open();
                return;
            }

            await GetAllAsync();
            Toast.Show("Categoria atualizada", ToastType.Success);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao editar categoria: {ex.Message}");
        }
    }

    private void HandleDeleteConfirm(long id)
    {
        idToDelete = id;
        confirmDialog.Open();
    }

    private async Task DeleteConfirmedAsync()
    {
        try
        {
            var result = await Service.DeleteAsync(idToDelete, CancellationToken);

            if (result.IsFailure)
            {
                alertBox.Message = result.Error.Description!;
                alertBox.Type = AlertBoxType.Warning;
                alertBox.Open();
                return;
            }

            await GetAllAsync();
            Toast.Show("Categoria removida", ToastType.Success);
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }


    private async Task SortBy(string column)
    {
        if (sortColumn == column)
        {
            sortOrder = sortOrder == "asc" ? "desc" : "asc";
        }
        else
        {
            sortColumn = column;
            sortOrder = "asc";
        }

        currentPage = 1; // Resetar para primeira página ao ordenar
        await GetAllAsync();
    }


    private async Task HandlePageChanged(int newPage)
    {
        if (newPage >= 1 && newPage <= totalPages)
        {
            currentPage = newPage;
            await GetAllAsync();
        }
    }

    private async Task OnSearchChanged(string value)
    {
        searchText = value;
        currentPage = 1; // Resetar para primeira página ao buscar
        await Debounce(GetAllAsync);
    }
}
